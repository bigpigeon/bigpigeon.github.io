---
layout: post
title:  "pac脚本优化"
date:   2015-12-19 22:00:00
categories: pac javascript swithy  
excerpt: 降低pac脚本的时间复杂度
---

最近发现lantern和shadowsocks client自生成pac都一定的性能问题，在url数目上升到一定程度的时候加载速度明显慢了很多.

于是我翻看了它们的实现

- lantern
  - 把所有需要代理的domain组合成一个RegExp，然后在FindProxyForURL时对host做RegExp.exec的操作来判断是否需要代理
- shadownsocks
  -   把domain做成一个{domain:1,...}的字典，然后在FindProxyForURL时对host做domains.hasOwnProperty判断是否在字典内，若不在，则去掉最前面的'.'和之前的内容 继续做domains.hasOwnProperty判断

可以看出lantern的pac会严重影响网页的加载速度，shadowsocks的稍微好点，但在遇到不需要代理的网页时则会消耗更多无谓的判断

于是我自己实现一个pac优化FindProxyForURL匹配速度

我的思路是:

- 把所有需要代理的url以 '.' 分割成节点
- 然后存入一个dict 格式如下

```javascript
{
  "com": {
    "google": true,
    "blogspot": {
      "www": true  
    }
  }
}
```

- 在FindProxyForURL中把host也split成list与这个dict match一下
- 贴上源码

```javascript
var domains = [
    "google.com",
    "www.blogspot.com",
    ...
];
var domain_dict = {};
for(var i = 0; i < domains.length; i++){
    if(domains[i].endsWith(".")){
        domains[i] = domains[i].slice(0, -1)
    }
    var url_list = domains[i].split('.');

    var domain_node = domain_dict;
    for(var j = url_list.length; j > 0; j--){
        var node_name = url_list[j-1];
        if (!domain_node.hasOwnProperty(node_name)){
            if (j === 1){
                domain_node[node_name] = true;
                break;
            } else {
                domain_node[node_name] = {};
            }
        } else if(domain_node[node_name] === true) {
            break;
        }
        domain_node = domain_node[node_name];
    }
}

var proxy = "SOCKS5 127.0.0.1:1080; SOCKS 127.0.0.1:1080; DIRECT";

var direct = 'DIRECT;';

function FindProxyForURL(url, host) {
    if( host == "localhost" ||
        host == "127.0.0.1") {
        return direct;
    }
    var host_list = host.split('.')
    var domain_node = domain_dict
    for(var i = host_list.length; i > 0; i--){
        var node_name = host_list[i-1]
        if (domain_node.hasOwnProperty(node_name)){
            if(domain_node[node_name] === true){
                return proxy;
            } else {
                domain_node = domain_node[node_name]
            }

        }
        else {
            return direct;
        }
    }
    return direct;
}
```

- 以下是我在nodejs下的性能测试结果 [测试js下载地址](/static/testdata/pac_benchmark.zip)


```
[root@bigpigeon pac_benchmark]# node benchmark.js 10000
       shadowsocks benchmark
proxy_domain_two_node result 3ms
no_proxy_domain_two_node result 2ms
proxy_domain_three_node result 6ms
no_proxy_domain_three_node result 3ms
proxy_domain_four_node result 5ms
no_proxy_domain_four_node result 4ms
       lantern benchmark
proxy_domain_two_node result 4ms
no_proxy_domain_two_node result 32ms
proxy_domain_three_node result 2ms
no_proxy_domain_three_node result 39ms
proxy_domain_four_node result 18ms
no_proxy_domain_four_node result 47ms
       bigpigeon_pac benchmark
proxy_domain_two_node result 3ms
no_proxy_domain_two_node result 3ms
proxy_domain_three_node result 11ms
no_proxy_domain_three_node result 3ms
proxy_domain_four_node result 3ms
no_proxy_domain_four_node result 3ms
[root@bigpigeon pac_benchmark]# node benchmark.js 100000
       shadowsocks benchmark
proxy_domain_two_node result 24ms
no_proxy_domain_two_node result 22ms
proxy_domain_three_node result 37ms
no_proxy_domain_three_node result 37ms
proxy_domain_four_node result 47ms
no_proxy_domain_four_node result 51ms
       lantern benchmark
proxy_domain_two_node result 29ms
no_proxy_domain_two_node result 279ms
proxy_domain_three_node result 27ms
no_proxy_domain_three_node result 373ms
proxy_domain_four_node result 163ms
no_proxy_domain_four_node result 441ms
       bigpigeon_pac benchmark
proxy_domain_two_node result 27ms
no_proxy_domain_two_node result 23ms
proxy_domain_three_node result 29ms
no_proxy_domain_three_node result 24ms
proxy_domain_four_node result 29ms
no_proxy_domain_four_node result 24ms
[root@bigpigeon pac_benchmark]# node benchmark.js 1000000
       shadowsocks benchmark
proxy_domain_two_node result 136ms
no_proxy_domain_two_node result 130ms
proxy_domain_three_node result 287ms
no_proxy_domain_three_node result 309ms
proxy_domain_four_node result 401ms
no_proxy_domain_four_node result 460ms
       lantern benchmark
proxy_domain_two_node result 222ms
no_proxy_domain_two_node result 2776ms
proxy_domain_three_node result 258ms
no_proxy_domain_three_node result 3698ms
proxy_domain_four_node result 1631ms
no_proxy_domain_four_node result 4420ms
       bigpigeon_pac benchmark
proxy_domain_two_node result 224ms
no_proxy_domain_two_node result 220ms
proxy_domain_three_node result 285ms
no_proxy_domain_three_node result 218ms
proxy_domain_four_node result 287ms
no_proxy_domain_four_node result 220ms

```